<!DOCTYPE html>

<html>
    <head>
        <title>LabMate - Laboratories</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/css/pop-up.css">
        <link rel="stylesheet" href="/css/theme-style.css">
        <link rel="stylesheet" href="/css/navbar-style.css">
        <link rel="stylesheet" href="/css/labtech-laboratories.css">

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="/js/seat-manager.js"></script>

        <script>
            $(document).ready(function() {
                $.getScript("/js/navbar-labtech.js");
                // Initialize seats with labtech mode
                initializeSeats(false, true);
            });
        </script>
    </head>

    <body>
        <div data-include="navbar-labtech-signedin"></div>

        <div class = "frame">
            <span class = "header">Reserve a Slot</span>

            <div class = "dropdown">
                <span class = "dropdown-header">Laboratory</span>

                <select name = "labs" id = "labs">
                    <option value = "" disabled selected>Select a Laboratory</option>
                    {{#each labs}}
                        <option value="{{this.laboratoryName}}" data-capacity = {{this.capacity}}>{{this.laboratoryName}}</option>
                    {{/each}}
                </select>

            </div>

            
            <div class = "dropdown">
                <span class = "dropdown-header">Date</span>

                <select name = "dates" id = "dates">
                    <option value = "" disabled selected>Select a Date</option>
                    {{#each next7Days}}
                        <option value="{{this.formattedDate}}">{{this.displayDate}}</option>
                    {{/each}}
                </select>
            </div>

            <button id = "view-button">View Slots</button>

            <div id = "chart">
                <span id = "chart-header">Slot Availability</span>

                <div id = "chart-body">
                    <table id = "slot-chart">
                        <thead>
                            <tr>
                                <th id = "seat-header">Seat</th>
                                {{#each timeSlots}}
                                    <th>{{this}}</th>
                                {{/each}}
                            </tr>
                        </thead>

                        <tbody id = "timetable">
                            {{#range 1 5}}
                            <tr>
                                <th id="seats">Seat {{this}}</th>
                                {{#each ../timeSlots}}
                                    <td>
                                        {{#if (findReservation ../this this)}}
                                            <button class="taken-seat" data-seat-number="{{../this}}" data-time-slot="{{@index}}" onclick="togglePopup('popup-frame-{{findReservationIndex ../this this}}')"></button>
                                        {{else}}
                                            <button class="clickable-seat" data-seat-number="{{../this}}" data-time-slot="{{@index}}"></button>
                                        {{/if}}
                                    </td>
                                {{/each}}
                            </tr>
                            {{/range}}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id = "legend">
                <div id = "legend-available">
                </div>
                <span class = "legend-text">Available</span>
                <div id = "legend-selected">
                </div>
                <span class = "legend-text">Selected</span>
                <div id = "legend-unavailable">
                </div>
                <span class = "legend-text">Unavailable</span>
                <div id = "legend-booking">
                </div>
                <span class = "legend-text">Your Booking</span>
            </div>

            <div class = "dropdown">
                <span class = "dropdown-header">Reserve until...</span>

                <select name = "endtimes" id = "endtimes">
                    <option value = "" disabled selected>Select an End Time</option>
                    <option value = "time1">8:00 AM</option>
                    <option value = "time2">8:30 AM</option>
                    <option value = "time3">9:00 AM</option>
                    <option value = "time4">9:30 AM</option>
                    <option value = "time5">10:00 AM</option>
                    <option value = "time6">10:30 AM</option>
                    <option value = "time7">11:00 AM</option>
                    <option value = "time8">11:30 AM</option>
                    <option value = "time9">12:00 PM</option>
                </select>
            </div>

            <div class = "dropdown">
                <span class = "dropdown-header">Student's Name</span>

                <input type = "text" id = "student-name">
            </div>

            <button id = "reserve-button" onclick="openPopup()"> Create Booking for Student </button>
        </div>

        <div id="overlay" class="overlay"></div>

        <div class="container">
            <div class=popup id="confirm-popup">
                <img src="img/reservation.png" class="icon" style="margin-bottom: 15px;"/>
                <p class="message">Would you like to proceed with your reservation?
                </p>
            
                <div class="btn-wrapper">
                    <button type="cancel" class="btn1" onclick="cancel();">Cancel</button>
                </div>
    
                <div class="btn-wrapper">
                    <button type="confirm" class="btn2" onclick="confirm();">Confirm</button>
                </div>
            </div>

        </div>

        <script>
            function togglePopup(popupId) {
                document.querySelectorAll(".popup2").forEach(popup => {
                    if(popup.id != popupId) {
                        popup.classList.remove('show');
                    }
                });
                const popup = document.getElementById(popupId);
                popup.classList.toggle('show');
            }

            function openPopup() {
                document.getElementById("confirm-popup").style.display = "block";
                document.getElementById("overlay").style.display = "block";
            }

            function confirm() {
                const selectedLab = document.getElementById('labs').value;
                const selectedDate = document.getElementById('dates').value;
                const studentName = document.getElementById('student-name').value;
                const selectedSeat = document.querySelector('.selected-seat');
                const endTime = document.getElementById('endtimes').value;

                if (!selectedLab || !selectedDate || !studentName || !selectedSeat || !endTime) {
                    alert('Please fill in all required fields');
                    return;
                }

                const seatNumber = selectedSeat.getAttribute('data-seat-number');
                const timeSlot = selectedSeat.getAttribute('data-time-slot');
                const startTime = document.querySelector(`thead th:nth-child(${parseInt(timeSlot) + 2})`).textContent;

                const reservationData = {
                    laboratoryRoom: selectedLab,
                    seatNumber: parseInt(seatNumber),
                    reservationDate: selectedDate,
                    startTime: startTime,
                    endTime: endTime,
                    studentName: studentName
                };

                fetch('/api/labtech/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reservationData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Reservation created successfully!');
                        location.reload();
                    } else {
                        alert(data.message || 'Failed to create reservation');
                    }
                })
                .catch(error => {
                    console.error('Error creating reservation:', error);
                    alert('Failed to create reservation. Please try again.');
                });

                document.getElementById("confirm-popup").style.display = "none";
                document.getElementById("overlay").style.display = "none";
            }

            function cancel() {
                document.getElementById("confirm-popup").style.display = "none";
                document.getElementById("overlay").style.display = "none";
            }

            document.getElementById("view-button").addEventListener("click", function() {
                const selectedLab = document.getElementById("labs").value;
                const selectedDate = document.getElementById("dates").value;

                if (!selectedLab || !selectedDate) {
                    alert('Please select both laboratory and date.');
                    return;
                }

                updateSeatStatus();
            });
        </script>
    </body>
</html>
