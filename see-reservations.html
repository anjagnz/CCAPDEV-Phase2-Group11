<!DOCTYPE html>
<html>
<head>
    <title>LabMate - Reservations</title>
    <link rel="stylesheet" href="css/theme-style.css">
    <link rel="stylesheet" href="css/navbar-style.css">
    <link rel="stylesheet" href="css/see-reservations.css">
    <link rel="stylesheet" href="css/pop-up.css">
    <link rel="stylesheet" href="css/reservation-details.css">

    <!-- Imported Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- add navigation bar and interactivity  -->
        <script>
            /* adds outline design on active page in navigation bar */
            $(document).ready(function() {$.getScript("js/navbar.js");});
        </script>
</head>
<body>
    
    <!-- insert navigation bar for signed in view -->
    <div data-include="navbar-signedin"></div>
    
    <h1>Your Reservations</h1>

    <!-- Reservations  -->
    <div class="reservations">
        <table>
            <thead>
                <tr>
                    <th></th>
                    <th>Laboratory Room</th>
                    <th>Reservation Date</th>
                    <th>Time Slot</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Reservations will be inserted here -->
            </tbody>
        </table>
    </div>
    
    <div class="remove-btn-wrapper">
        <button type="button" class="remove-btn" onclick="openPopup1()">Remove Reservation</button>
    </div>
        
    <div id="overlay" class="overlay"></div>

    <!-- Reservation Details -->
    <div class="popup" id="reservation-details" style="margin-top: 20px; height: 86vh; width: 50%; background-color: #fbfcf6;">
        
        <!-- Reservation details will be inserted here -->
        
    </div> 

    <!-- Remove Reservation -->
    <div class="popup" id="remove-reservation" style="margin-top: 20px">
        <img src="img/message_icon.png" class="icon"/>
        <p class="message">Are you sure you want to remove this reservation? <br>
            This action cannot be undone.
        </p>
        
        <div class="btn-wrapper">
            <button type="button" class="btn1" onclick="cancel()">Cancel</button>
        </div>
            
        <div class="btn-wrapper">
            <button type="button" class="btn2" onclick="confirm()">Confirm</button>
        </div>
    </div>

    <script>
        // Function to load and display reservations
        async function loadReservations() {
            try {
                const response = await fetch("/api/reservations"); // fetch only the reservations of the logged in user for Phase 3
                const reservations = await response.json();

                const tableBody = document.querySelector("tbody");
                tableBody.innerHTML = ""; // Clear existing content

                reservations.forEach(reservation => {
                    var reservationDate = reservation.reservationDate.split('T')[0].trim(); // Extract only the date part

                    // Create radio button
                    const radio = document.createElement("input");
                    radio.type = "radio";
                    radio.name = "select-option";
                    radio.classList.add("select-btn");
                    radio.value = reservation._id; // Assign reservation ID

                    // Create reservation detail icon
                    const icon = document.createElement("img");
                    icon.src = "img/reservation-details.jpeg";
                    icon.style = "height: 25px; cursor: pointer";
                    icon.dataset.reservationId = reservation._id;
                    icon.addEventListener("click", function () { 
                        openPopup2(this.dataset.reservationId);
                    });  
                    icon.setAttribute("data-reservationId", reservation._id);

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td style="text-align: right;"></td> <!-- Empty cell for radio button -->
                        <td>${reservation.laboratoryRoom}</td>
                        <td>${reservationDate}</td>
                        <td><span id="start"> ${reservation.startTime} </span> - <span id="end"> ${reservation.endTime} </span></td>
                        <td style="text-align: left;">
                            <!-- Empty cell for icon -->
                        </td>
                    `;

                    // Append the radio button and reservation detail icon
                    row.children[0].appendChild(radio);
                    row.children[4].appendChild(icon);

                    tableBody.appendChild(row);
                });

                let removeButton = document.querySelector(".remove-btn");
                removeButton.disabled = true;

                // Enable remove button when a radio button is selected
                function enableRemoveButton() {
                    removeButton.disabled = false;
                }

                document.querySelectorAll(".select-btn").forEach(radio => {
                    radio.addEventListener('change', enableRemoveButton);
                });
            } catch (error) {
                console.error("Error fetching reservations:", error);
            }
        }

        // Initial call to load reservations when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            loadReservations();
        });

        async function loadReservationDetails(reservationId) {
            try {
                const response = await fetch(`/api/reservations/${reservationId}`, { method: "GET" });
                const reservation = await response.json();

                let reservationDetails = document.querySelector("#reservation-details");

                // extract necessary details
                var reservationDate = reservation.reservationDate.split('T')[0].trim(); // Extract only the date part
                var formattedDate = formatDate(new Date(reservation.bookingDate)).split("T");
                var bookingDate = formattedDate[0];
                var bookingTime = formattedDate[1];

                if (reservation.studentName){ // for walk in students
                    reservationDetails.innerHTML = `
                    <h1 style="text-align: center; padding-top: 30px; padding-bottom: 18px; font-size: 28px;">Reservation Details</h1>
                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                           Student Name:
                        </div>
                        <input type="text" id="lab-room" class="text-field" value="${reservation.studentName}" data-label="laboratoryRoom"  disabled> 
                    </div>
                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                           Laboratory Room:
                        </div>
                        <input type="text" id="lab-room" class="text-field" value="${reservation.laboratoryRoom}" data-label="laboratoryRoom"  disabled> 
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Seat Number:
                        </div>
                        <input type="text" id="seat-num" class="text-field" value="${reservation.seatNumber}" data-label="seatNumber"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Date of Booking:
                        </div>
                        <input type="text" id="booking-date" class="text-field" value="${bookingDate}" data-label="bookingDate"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Time of Booking:
                        </div>
                        <input type="text" id="booking-time" class="text-field" value="${bookingTime}" disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Reservation Date:
                        </div>
                        <input type="text" id="reserve-date" class="text-field" value="${reservationDate}" data-label="reservationDate"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Start Time:
                        </div>
                        <input type="text" id="start-time" class="text-field" value="${reservation.startTime}"  data-label="startTime" disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            End Time:
                        </div>
                        <input type="text" id="end-time" class="text-field" name="editable" value="${reservation.endTime}" data-label="endTime"  disabled>
                    </div>

                    <div class="footer">
                        <div class="button-wrapper">
                            <button type="button" class="btn-1" id="edit-btn" onclick="edit('${reservationId}')">Edit Reservation</button>
                        </div>

                        <div class="button-wrapper">
                            <button type="done" class="btn-2" id="done-btn" onclick="done()">Done</button>
                        </div>
                    </div>
                `;
                } else{
                    reservationDetails.innerHTML = `
                    <h1 style="text-align: center; padding-top: 30px; padding-bottom: 18px; font-size: 28px;">Reservation Details</h1>
                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                           Laboratory Room:
                        </div>
                        <input type="text" id="lab-room" class="text-field" value="${reservation.laboratoryRoom}" data-label="laboratoryRoom"  disabled> 
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Seat Number:
                        </div>
                        <input type="text" id="seat-num" class="text-field" value="${reservation.seatNumber}" data-label="seatNumber"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Date of Booking:
                        </div>
                        <input type="text" id="booking-date" class="text-field" value="${bookingDate}" data-label="bookingDate"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Time of Booking:
                        </div>
                        <input type="text" id="booking-time" class="text-field" value="${bookingTime}" disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Reservation Date:
                        </div>
                        <input type="text" id="reserve-date" class="text-field" value="${reservationDate}" data-label="reservationDate"  disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            Start Time:
                        </div>
                        <input type="text" id="start-time" class="text-field" value="${reservation.startTime}"  data-label="startTime" disabled>
                    </div>

                    <div class="input-wrapper">
                        <div class="label-wrapper">            
                            End Time:
                        </div>
                        <input type="text" id="end-time" class="text-field" name="editable" value="${reservation.endTime}" data-label="endTime"  disabled>
                    </div>

                    <div class="footer">
                        <div class="button-wrapper">
                            <button type="button" class="btn-1" id="edit-btn" onclick="edit('${reservationId}')">Edit Reservation</button>
                        </div>

                        <div class="button-wrapper">
                            <button type="done" class="btn-2" id="done-btn" onclick="done()">Done</button>
                        </div>
                    </div>
                `;
                }
            
                
            } catch (error) {
                console.error("Error fetching reservations:", error);
            }
        }

        let remove= document.getElementById("remove-reservation");
        let details = document.querySelector("#reservation-details");
        let overlay = document.getElementById("overlay");
        let radioButtons = document.querySelectorAll(".select-btn");
        let removeButton = document.querySelector(".remove-btn");
        let editableButtons = document.querySelectorAll('[name="editable-buttons"]');

        function openPopup1() {
            remove.classList.add("open-popup");
            overlay.style.display = "block"; 
        }

        async function openPopup2(reservationId) {
            if (!reservationId) {
                console.error("No reservation selected.");
                return;
            }

            await loadReservationDetails(reservationId);
            details.classList.add("open-popup");
            overlay.style.display = "block";
        }


        // Function to delete a reservation
        async function deleteReservation() {
            try {
                let selectedReservation = null;

                // Find the selected reservation
                document.querySelectorAll(".select-btn").forEach(radio => {
                    if (radio.checked) {
                        selectedReservation = radio.value;  // Get the selected reservation's ID
                    }
                });

                // If no reservation is selected, show an alert and exit
                if (!selectedReservation) {
                    alert("Please select a reservation to delete.");
                    return;
                }

                // Send DELETE request to the server
                const response = await fetch(`/api/reservations/${selectedReservation}`, { method: 'DELETE' });

                // Check if the deletion was successful
                if (!response.ok) {
                    throw new Error("Failed to delete reservation.");
                }

                console.log("Reservation deleted successfully!");
            } catch (error) {
                console.error("Error deleting reservation:", error);
            }
        }

        // Confirm deletion
        async function confirm() {
            try {
                // Close the popup and hide the overlay
                remove.classList.remove("open-popup");
                overlay.style.display = "none"; 

                // Wait for the deletion to complete before refreshing the list
                await deleteReservation();

                // Refresh the reservations list after deletion
                loadReservations();
            } catch (error) {
                console.error("Error confirming deletion:", error);
            }

        }

        function cancel() {
            remove.classList.remove("open-popup");
            overlay.style.display = "none"; 
        }

        function done(){
            details.classList.remove("open-popup");
            overlay.style.display = "none";
        
        }

        async function edit(reservationId) {
            console.log(reservationId);
            // Find the currently active popup
            let popups = document.querySelectorAll(".popup");
            let activePopup = Array.from(popups).find(popup => 
                getComputedStyle(popup).visibility === "visible"
            );
            if (!activePopup) return; 

            let editableFields = activePopup.querySelectorAll(".text-field[name='editable']");

            editableFields.forEach(inputField => {
                let select = document.createElement("select"); 
                select.className = inputField.className;
                select.name = inputField.dataset.label;

                let options = [inputField.value, "05:00 P.M.", "05:30 P.M.", "06:00 P.M."];

                options.forEach(optionText => {
                    let option = document.createElement("option");
                    option.value = optionText;
                    option.textContent = optionText;
                    select.appendChild(option);
                });

                select.value = inputField.value;
                
                // Store original text value in data attribute
                select.setAttribute("data-original-value", inputField.value);

                inputField.replaceWith(select);
                inputField.disabled = true;
            });

            let editButton = activePopup.querySelector("#edit-btn");
            let doneButton = activePopup.querySelector("#done-btn");

            doneButton.textContent = "Save Changes";
            doneButton.setAttribute("onclick", `saveChanges('${reservationId}')`);

            editButton.textContent = "Cancel";
            editButton.setAttribute("onclick", `cancelChanges('${reservationId}')`);
        }

        function cancelChanges(reservationId) {
            // Find the currently active popup
            let popups = document.querySelectorAll(".popup");
            let activePopup = Array.from(popups).find(popup => 
                getComputedStyle(popup).visibility === "visible"
            );
            if (!activePopup) return; 

            let editableFields = activePopup.querySelectorAll("select");

            editableFields.forEach(selectField => {
                let textField = document.createElement("input");
                textField.className = selectField.className;  
                textField.value = selectField.getAttribute("data-original-value"); // Restore original value
                textField.type = "text"; 
                textField.name = "editable"; 

                selectField.replaceWith(textField); // Replace select with input field
                textField.disabled = true;
            });

            let editButton = activePopup.querySelector("#edit-btn");
            let doneButton = activePopup.querySelector("#done-btn");

            doneButton.textContent = "Done";
            doneButton.setAttribute("onclick", `saveChanges('${reservationId}')`);

            editButton.textContent = "Edit Reservation";
            editButton.setAttribute("onclick", `edit('${reservationId}')`);
        }

        async function saveChanges(reservationId) {
            // Find the currently active popup
            let popups = document.querySelectorAll(".popup");
            let activePopup = Array.from(popups).find(popup => 
                getComputedStyle(popup).visibility === "visible"
            );
            if (!activePopup) return; 

            let editableFields = activePopup.querySelectorAll("select");

            let updateData = {}; // Object to store updated fields

            editableFields.forEach(selectField => {
                let newValue = selectField.value; // Get the selected value
                let fieldName = selectField.name; 

                updateData[fieldName] = newValue; // Store new value

                let textField = document.createElement("input");
                textField.className = selectField.className;
                textField.value = newValue;
                textField.type = "text";
                textField.name = "editable";

                selectField.replaceWith(textField);
                textField.disabled = true;
            });

            // Send the PATCH request with updated values
            try {
                let response = await fetch(`/api/reservation/${reservationId}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(updateData),
                });

                if (!response.ok) {
                    throw new Error("Failed to update reservation");
                }

                console.log("Reservation updated successfully");

                // Load updated reservation
                await loadReservations();

            } catch (error) {
                console.error("Error updating reservation:", error);
            }

            let editButton = activePopup.querySelector("#edit-btn");
            let doneButton = activePopup.querySelector("#done-btn");

            doneButton.textContent = "Done";
            doneButton.setAttribute("onclick", "saveChanges()");

            editButton.textContent = "Edit Reservation";
            editButton.setAttribute("onclick", "edit()"); // Reset edit function

            activePopup.classList.remove("open-popup");
            overlay.style.display = "none";


        }

        // For date formatting
        function formatDate(today) {  
		    let formattedDate = today.getFullYear().toString() + '-' + (today.getMonth() + 1).toString().padStart(2, 0) + '-' + today.getDate().toString().padStart(2, 0) + 'T' + today.getHours().toString().padStart(2, 0) + ':' + today.getMinutes().toString().padStart(2, 0);
		    return formattedDate;
	    }


    </script>
</body>
</html>
